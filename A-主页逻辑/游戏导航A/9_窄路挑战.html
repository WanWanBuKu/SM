<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>çª„è·¯æŒ‘æˆ˜- ç²¾ç¾ç‰ˆ</title>
    
            <!-- å¼•å…¥æ•°æ®åº“ç®¡ç†å™¨ -->
    <script src="/db.js"></script>
    
        <!-- å¼•å…¥æ’ä»¶å·¥å…·ç®± ğŸ„-->
    <script src="/A2_å…¨å±€ä¸­å¿ƒ/B_æ’ä»¶å·¥å…·/toolbox.js"></script>  
    
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #ffeef8 0%, #ffe0f0 50%, #ffd1e8 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        
        #gameContainer {
            position: relative;
            text-align: center;
        }
        
        canvas {
            border: 3px solid #ff69b4;
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.4);
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 15px;
        }
        
        #info {
            color: #d63384;
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        #controls {
            color: #d63384;
            margin-top: 10px;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        /* å…³å¡é€‰æ‹©ç•Œé¢- ç²‰è‰²ä¸»é¢˜ */
        #levelSelectLayer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffeef8 0%, #ffd1e8 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4000;
        }
        
        #levelSelectContent {
            text-align: center;
            max-width: 90%;
            padding: 20px;
        }
        
        #levelSelectContent h1 {
            font-size: 42px;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #ff69b4, #ff1493);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }
        
        .levelGrid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .levelButton {
            width: 80px;
            height: 80px;
            border: 3px solid #ff69b4;
            background: linear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%);
            color: #d63384;
            border-radius: 20px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
        }
        
        .levelButton:hover {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.5);
        }
        
        .levelButton.locked {
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
            border-color: #ccc;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }
        
        /* æ‘‡æ†æ ·å¼- ç²‰è‰²ä¸»é¢˜ */
        #joystickContainer {
            position: fixed;
            bottom: 50px;
            left: 50px;
            width: 150px;
            height: 150px;
            z-index: 1000;
            touch-action: none;
        }
        
        #joystickBase {
            position: absolute;
            width: 150px;
            height: 150px;
            background: rgba(255, 105, 180, 0.2);
            border: 2px solid rgba(255, 105, 180, 0.5);
            border-radius: 50%;
            touch-action: none;
        }
        
        #joystickKnob {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 105, 180, 0.6);
            border: 2px solid rgba(255, 105, 180, 0.9);
            border-radius: 50%;
            left: 45px;
            top: 45px;
            transition: none;
            touch-action: none;
        }
        
        /* å…¨å±è§¦æ‘¸å±‚ */
        #touchLayer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            touch-action: none;
        }
        
        /* æ¸¸æˆç»“æŸè¦†ç›–å±‚ */
        #gameOverLayer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 105, 180, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        #gameOverContent {
            text-align: center;
            color: white;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        #gameOverContent h2 {
            font-size: 42px;
            margin-bottom: 20px;
            color: #d63384;
        }
        
        #gameOverContent p {
            font-size: 20px;
            color: #666;
            margin-bottom: 30px;
        }
        
        #gameOverContent button {
            font-size: 20px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
        }
        
        #gameOverContent button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
        }
        
        /* é€šå…³è¦†ç›–å±‚ */
        #victoryLayer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 105, 180, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        
        #victoryContent {
            text-align: center;
            color: white;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        #victoryContent h2 {
            font-size: 42px;
            margin-bottom: 20px;
            color: #d63384;
            animation: pulse 1s ease infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        #victoryContent p {
            font-size: 20px;
            color: #666;
            margin-bottom: 30px;
        }
        
        #victoryContent button {
            font-size: 18px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
        }
        
        #victoryContent button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
        }
        
        /* ç¬‘è„¸è¦†ç›–å±‚ */
        #smileyLayer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            animation: flashRed 0.5s ease-in-out;
        }
        
        @keyframes flashRed {
            0% { background-color: rgba(255, 0, 0, 0.8); }
            50% { background-color: rgba(255, 105, 180, 0.9); }
            100% { background-color: rgba(255, 0, 0, 0.8); }
        }
        
        #smileyContent {
            text-align: center;
            color: #ffffff;
            font-size: 150px;
            animation: bounce 0.6s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            #joystickContainer {
                bottom: 30px;
                left: 30px;
                width: 120px;
                height: 120px;
            }
            
            #joystickBase {
                width: 120px;
                height: 120px;
            }
            
            #joystickKnob {
                width: 48px;
                height: 48px;
                left: 36px;
                top: 36px;
            }
            
            #gameOverContent h2, #victoryContent h2 {
                font-size: 32px;
            }
            
            #smileyContent {
                font-size: 100px;
            }
            
            #levelSelectContent h1 {
                font-size: 32px;
            }
            
            .levelButton {
                width: 70px;
                height: 70px;
                font-size: 20px;
            }
            
            .levelGrid {
                gap: 10px;
                max-width: 600px;
            }
        }
        
        @media (max-width: 480px) {
            .levelGrid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                max-width: 300px;
            }
            
            .levelButton {
                width: 60px;
                height: 60px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div id="touchLayer"></div>
    
    <!-- å…³å¡é€‰æ‹©ç•Œé¢ -->
    <div id="levelSelectLayer">
        <div id="levelSelectContent">
            <h1>ğŸŒ¸é€‰æ‹©å…³å¡ğŸŒ¸</h1>
            <div class="levelGrid" id="levelGrid"></div>
        </div>
    </div>
    
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="info">
            ä½¿ç”¨æ‘‡æ†ç§»åŠ¨ï¼Œ<span style="color: #ff1493; font-weight: bold;">ç¢°åˆ°å¢™å£å³æ¸¸æˆç»“æŸï¼</span>
        </div>
        <div id="controls">
            <div>èµ·å§‹å®½åº¦: <span id="startWidth">100px</span> â†’æœ€ç»ˆå®½åº¦:<span id="endWidth">10px</span></div>
            <div>ç©å®¶å¤§å°: 5Ã—5px</div>
            <div><span style="color: #ff1493;">æç¤ºï¼šåˆ°è¾¾ç²‰è‰²å‡ºå£åŒºåŸŸå³å¯é€šå…³ï¼</span></div>
        </div>
    </div>
    
    <div id="joystickContainer">
        <div id="joystickBase"></div>
        <div id="joystickKnob"></div>
    </div>
    
    <div id="gameOverLayer">
        <div id="gameOverContent">
            <h2>æ¸¸æˆç»“æŸï¼</h2>
            <p>ä½ ç¢°åˆ°äº†å¢™å£ï¼</p>
            <button onclick="restartGame()">é‡æ–°å¼€å§‹</button>
            <button onclick="backToLevelSelect()">è¿”å›é€‰å…³</button>
        </div>
    </div>
    
    <div id="victoryLayer">
        <div id="victoryContent">
            <h2>ğŸ‰æ­å–œé€šå…³ï¼ğŸ‰</h2>
            <p>ä½ æˆåŠŸå®Œæˆäº†ç¬¬<span id="currentLevelNum">1</span> å…³ï¼</p>
            <button onclick="nextLevel()">ä¸‹ä¸€å…³</button>
            <button onclick="backToLevelSelect()">è¿”å›é€‰å…³</button>
        </div>
    </div>
    
    <div id="smileyLayer">
        <div id="smileyContent">ğŸ˜ˆ</div>
    </div>

    <script>
        // 1. è·å–ç”»å¸ƒå’Œä¸Šä¸‹æ–‡
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // 2. æ¸¸æˆè®¾ç½®
        const GRID_SIZE = 20;
        const INITIAL_WIDTH = 100;
        const WIDTH_REDUCTION = 15;
        const MIN_WIDTH = 15; // ç¡®ä¿æœ€å°å®½åº¦ä¸ºç©å®¶å¤§å°çš„3å€
        const NARROW_WIDTH_THRESHOLD = 20;
        const FINAL_SEGMENT_WIDTH = 15;
        
        // 3. ç©å®¶è®¾ç½®
        let player = {
            x: 100,
            y: 300,
            size: 2.5,
            speed: 2
        };
        
        // 4. æ¸¸æˆçŠ¶æ€
        let gameOver = false;
        let victory = false;
        let smileyTriggers = [];
        let currentSegmentIndex = -1;
        let currentLevel = 1;
        let unlockedLevels = 1;
        
        // 5. è·¯å¾„å®šä¹‰
        let pathSegments = [];
        let currentWidth = INITIAL_WIDTH;
        let pathPoints = [];
        let exitZone = null; // å‡ºå£åŒºåŸŸ
        
        // 6. é”®ç›˜çŠ¶æ€
        let keys = {};
        
        // 7. æ‘‡æ†æ§åˆ¶
        let joystick = {
            base: document.getElementById('joystickBase'),
            knob: document.getElementById('joystickKnob'),
            active: false,
            centerX: 75,
            centerY: 75,
            radius: 60,
            knobRadius: 24,
            deltaX: 0,
            deltaY: 0
        };
        
        // 8. å…³å¡è®¾è®¡- 20ä¸ªå…³å¡ï¼Œéš¾åº¦é€’å¢
        const levels = [
            // å‰ä¸¤å…³ä¿æŒç®€å•
            {
                id: 1,
                name: "å…¥é—¨å…³",
                startWidth: 100,
                endWidth: 90,
                turns: [
                    {x: 800, y: 300} // ç›´çº¿åˆ°ç»ˆç‚¹
                ],
                exitZone: {x: 750, y: 300, radius: 40}
            },
            {
                id: 2,
                name: "ç®€å•å…³",
                startWidth: 95,
                endWidth: 85,
                turns: [
                    {x: 400, y: 300},
                    {x: 750, y: 300}
                ],
                exitZone: {x: 750, y: 300, radius: 35}
            },
            
            // ç¬¬ä¸‰å…³å¼€å§‹éš¾åº¦é€’å¢ï¼ˆå‰å®½åçª„ï¼‰
            {
                id: 3,
                name: "å¹³ç¼“å…³",
                startWidth: 90,
                endWidth: 75,
                turns: [
                    {x: 300, y: 300},
                    {x: 300, y: 200},
                    {x: 600, y: 200},
                    {x: 750, y: 200}
                ],
                exitZone: {x: 750, y: 200, radius: 30}
            },
            {
                id: 4,
                name: "è½¬æŠ˜å…³",
                startWidth: 85,
                endWidth: 65,
                turns: [
                    {x: 200, y: 300},
                    {x: 200, y: 150},
                    {x: 500, y: 150},
                    {x: 500, y: 450},
                    {x: 750, y: 450}
                ],
                exitZone: {x: 750, y: 450, radius: 25}
            },
            {
                id: 5,
                name: "æ›²æŠ˜å…³",
                startWidth: 80,
                endWidth: 60,
                turns: [
                    {x: 150, y: 300},
                    {x: 350, y: 300},
                    {x: 350, y: 100},
                    {x: 550, y: 100},
                    {x: 550, y: 500},
                    {x: 750, y: 500}
                ],
                exitZone: {x: 750, y: 500, radius: 25}
            },
            
            // ä¸­æœŸå…³å¡ï¼ˆè·¯å¾„æ›´é•¿ï¼‰
            {
                id: 6,
                name: "èºæ—‹å…³",
                startWidth: 75,
                endWidth: 50,
                turns: [
                    {x: 100, y: 300},
                    {x: 300, y: 300},
                    {x: 300, y: 100},
                    {x: 500, y: 100},
                    {x: 500, y: 500},
                    {x: 700, y: 500},
                    {x: 700, y: 200},
                    {x: 750, y: 200}
                ],
                exitZone: {x: 750, y: 200, radius: 20}
            },
            {
                id: 7,
                name: "è›‡å½¢å…³",
                startWidth: 70,
                endWidth: 45,
                turns: [
                    {x: 100, y: 300},
                    {x: 200, y: 300},
                    {x: 200, y: 200},
                    {x: 300, y: 200},
                    {x: 300, y: 400},
                    {x: 400, y: 400},
                    {x: 400, y: 150},
                    {x: 550, y: 150},
                    {x: 550, y: 450},
                    {x: 700, y: 450},
                    {x: 700, y: 300},
                    {x: 750, y: 300}
                ],
                exitZone: {x: 750, y: 300, radius: 20}
            },
            {
                id: 8,
                name: "çª„é“å…³",
                startWidth: 65,
                endWidth: 40,
                turns: [
                    {x: 120, y: 300},
                    {x: 120, y: 120},
                    {x: 380, y: 120},
                    {x: 380, y: 480},
                    {x: 620, y: 480},
                    {x: 620, y: 200},
                    {x: 750, y: 200}
                ],
                exitZone: {x: 750, y: 200, radius: 20}
            },
            {
                id: 9,
                name: "é­”é¬¼å…³",
                startWidth: 60,
                endWidth: 35,
                turns: [
                    {x: 100, y: 300},
                    {x: 250, y: 300},
                    {x: 250, y: 100},
                    {x: 450, y: 100},
                    {x: 450, y: 500},
                    {x: 650, y: 500},
                    {x: 650, y: 150},
                    {x: 750, y: 150}
                ],
                exitZone: {x: 750, y: 150, radius: 18}
            },
            {
                id: 10,
                name: "ç»ˆæå…³",
                startWidth: 55,
                endWidth: 30,
                turns: [
                    {x: 80, y: 300},
                    {x: 200, y: 300},
                    {x: 200, y: 80},
                    {x: 400, y: 80},
                    {x: 400, y: 520},
                    {x: 600, y: 520},
                    {x: 600, y: 120},
                    {x: 720, y: 120},
                    {x: 720, y: 300},
                    {x: 750, y: 300}
                ],
                exitZone: {x: 750, y: 300, radius: 15}
            },
            
            // åæœŸå…³å¡ï¼ˆè¶…é•¿è·¯å¾„ï¼‰
            {
                id: 11,
                name: "è¶…é•¿å…³",
                startWidth: 50,
                endWidth: 28,
                turns: [
                    {x: 100, y: 300},
                    {x: 100, y: 100},
                    {x: 300, y: 100},
                    {x: 300, y: 500},
                    {x: 500, y: 500},
                    {x: 500, y: 100},
                    {x: 700, y: 100},
                    {x: 700, y: 500},
                    {x: 750, y: 500}
                ],
                exitZone: {x: 750, y: 500, radius: 15}
            },
            
            {
                id: 12,
                name: "æŠ˜å å…³",
                startWidth: 48,
                endWidth: 26,
                turns: [
                    {x: 80, y: 300},
                    {x: 80, y: 80},
                    {x: 200, y: 80},
                    {x: 200, y: 520},
                    {x: 350, y: 520},
                    {x: 350, y: 80},
                    {x: 500, y: 80},
                    {x: 500, y: 520},
                    {x: 650, y: 520},
                    {x: 650, y: 80},
                    {x: 750, y: 80}
                ],
                exitZone: {x: 750, y: 80, radius: 15}
            },
            
            {
                id: 13,
                name: "è¿·å®«å…³",
                startWidth: 46,
                endWidth: 24,
                turns: [
                    {x: 60, y: 300},
                    {x: 60, y: 100},
                    {x: 180, y: 100},
                    {x: 180, y: 500},
                    {x: 300, y: 500},
                    {x: 300, y: 100},
                    {x: 420, y: 100},
                    {x: 420, y: 500},
                    {x: 540, y: 500},
                    {x: 540, y: 100},
                    {x: 660, y: 100},
                    {x: 660, y: 500},
                    {x: 750, y: 500}
                ],
                exitZone: {x: 750, y: 500, radius: 15}
            },
            
            {
                id: 14,
                name: "å›ç¯å…³",
                startWidth: 44,
                endWidth: 22,
                turns: [
                    {x: 50, y: 300},
                    {x: 50, y: 50},
                    {x: 150, y: 50},
                    {x: 150, y: 550},
                    {x: 250, y: 550},
                    {x: 250, y: 50},
                    {x: 350, y: 50},
                    {x: 350, y: 550},
                    {x: 450, y: 550},
                    {x: 450, y: 50},
                    {x: 550, y: 50},
                    {x: 550, y: 550},
                    {x: 650, y: 550},
                    {x: 650, y: 50},
                    {x: 750, y: 50}
                ],
                exitZone: {x: 750, y: 50, radius: 15}
            },
            
            {
                id: 15,
                name: "æé™å…³",
                startWidth: 42,
                endWidth: 20,
                turns: [
                    {x: 40, y: 300},
                    {x: 40, y: 40},
                    {x: 140, y: 40},
                    {x: 140, y: 560},
                    {x: 240, y: 560},
                    {x: 240, y: 40},
                    {x: 340, y: 40},
                    {x: 340, y: 560},
                    {x: 440, y: 560},
                    {x: 440, y: 40},
                    {x: 540, y: 40},
                    {x: 540, y: 560},
                    {x: 640, y: 560},
                    {x: 640, y: 40},
                    {x: 740, y: 40},
                    {x: 740, y: 300},
                    {x: 750, y: 300}
                ],
                exitZone: {x: 750, y: 300, radius: 15}
            },
            
            // æœ€å5å…³ï¼ˆæéš¾å…³å¡ï¼‰
            {
                id: 16,
                name: "åœ°ç‹±å…³",
                startWidth: 40,
                endWidth: 18,
                turns: [
                    {x: 30, y: 300},
                    {x: 30, y: 30},
                    {x: 130, y: 30},
                    {x: 130, y: 570},
                    {x: 230, y: 570},
                    {x: 230, y: 30},
                    {x: 330, y: 30},
                    {x: 330, y: 570},
                    {x: 430, y: 570},
                    {x: 430, y: 30},
                    {x: 530, y: 30},
                    {x: 530, y: 570},
                    {x: 630, y: 570},
                    {x: 630, y: 30},
                    {x: 730, y: 30},
                    {x: 730, y: 570},
                    {x: 750, y: 570}
                ],
                exitZone: {x: 750, y: 570, radius: 15}
            },
            
            {
                id: 17,
                name: "å™©æ¢¦å…³",
                startWidth: 38,
                endWidth: 17,
                turns: [
                    {x: 20, y: 300},
                    {x: 20, y: 20},
                    {x: 120, y: 20},
                    {x: 120, y: 580},
                    {x: 220, y: 580},
                    {x: 220, y: 20},
                    {x: 320, y: 20},
                    {x: 320, y: 580},
                    {x: 420, y: 580},
                    {x: 420, y: 20},
                    {x: 520, y: 20},
                    {x: 520, y: 580},
                    {x: 620, y: 580},
                    {x: 620, y: 20},
                    {x: 720, y: 20},
                    {x: 720, y: 580},
                    {x: 750, y: 580}
                ],
                exitZone: {x: 750, y: 580, radius: 15}
            },
            
            {
                id: 18,
                name: "ç»æœ›å…³",
                startWidth: 36,
                endWidth: 16,
                turns: [
                    {x: 10, y: 300},
                    {x: 10, y: 10},
                    {x: 110, y: 10},
                    {x: 110, y: 590},
                    {x: 210, y: 590},
                    {x: 210, y: 10},
                    {x: 310, y: 10},
                    {x: 310, y: 590},
                    {x: 410, y: 590},
                    {x: 410, y: 10},
                    {x: 510, y: 10},
                    {x: 510, y: 590},
                    {x: 610, y: 590},
                    {x: 610, y: 10},
                    {x: 710, y: 10},
                    {x: 710, y: 590},
                    {x: 750, y: 590}
                ],
                exitZone: {x: 750, y: 590, radius: 15}
            },
            
            {
                id: 19,
                name: "æ— è§£å…³",
                startWidth: 34,
                endWidth: 15,
                turns: [
                    {x: 5, y: 300},
                    {x: 5, y: 5},
                    {x: 105, y: 5},
                    {x: 105, y: 595},
                    {x: 205, y: 595},
                    {x: 205, y: 5},
                    {x: 305, y: 5},
                    {x: 305, y: 595},
                    {x: 405, y: 595},
                    {x: 405, y: 5},
                    {x: 505, y: 5},
                    {x: 505, y: 595},
                    {x: 605, y: 595},
                    {x: 605, y: 5},
                    {x: 705, y: 5},
                    {x: 705, y: 595},
                    {x: 750, y: 595}
                ],
                exitZone: {x: 750, y: 595, radius: 15}
            },
            
            {
                id: 20,
                name: "ç»ˆç»“å…³",
                startWidth: 32,
                endWidth: 15,
                turns: [
                    {x: 5, y: 300},
                    {x: 5, y: 5},
                    {x: 80, y: 5},
                    {x: 80, y: 595},
                    {x: 155, y: 595},
                    {x: 155, y: 5},
                    {x: 230, y: 5},
                    {x: 230, y: 595},
                    {x: 305, y: 595},
                    {x: 305, y: 5},
                    {x: 380, y: 5},
                    {x: 380, y: 595},
                    {x: 455, y: 595},
                    {x: 455, y: 5},
                    {x: 530, y: 5},
                    {x: 530, y: 595},
                    {x: 605, y: 595},
                    {x: 605, y: 5},
                    {x: 680, y: 5},
                    {x: 680, y: 595},
                    {x: 750, y: 595}
                ],
                exitZone: {x: 750, y: 595, radius: 15}
            }
        ];
        
        // 9. åˆå§‹åŒ–å…³å¡é€‰æ‹©ç•Œé¢
        async function initLevelSelect() {
            // ä»æ•°æ®åº“è¯»å–å·²è§£é”å…³å¡
            const savedUnlocked = await IDB.get('D_unlockedLevels', 'userdata');
            if (savedUnlocked) {
                unlockedLevels = savedUnlocked;
            }
            
            const levelGrid = document.getElementById('levelGrid');
            levelGrid.innerHTML = '';
            
            for (let i = 1; i <= 20; i++) {
                const button = document.createElement('button');
                button.className = 'levelButton';
                button.textContent = i;
                
                if (i <= unlockedLevels) {
                    button.onclick = () => startLevel(i);
                } else {
                    button.className += ' locked';
                    button.textContent = 'ğŸ”’';
                }
                levelGrid.appendChild(button);
            }
        }
        
        // 10. ä¿å­˜è¿›åº¦åˆ°æ•°æ®åº“
        async function saveProgress() {
            if (currentLevel >= unlockedLevels) {
                unlockedLevels = currentLevel + 1;
                await IDB.put('D_unlockedLevels', unlockedLevels, 'userdata');
                console.log(`å·²è§£é”å…³å¡: ${unlockedLevels}`);
            }
        }
        
        // 11. å¼€å§‹æŒ‡å®šå…³å¡
        function startLevel(levelNum) {
            currentLevel = levelNum;
            const level = levels[levelNum - 1];
            
            // éšè—å…³å¡é€‰æ‹©ç•Œé¢
            document.getElementById('levelSelectLayer').style.display = 'none';
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameOver = false;
            victory = false;
            smileyTriggers = [];
            currentSegmentIndex = -1;
            
            // è®¾ç½®å‡ºå£åŒºåŸŸ
            exitZone = level.exitZone;
            
            // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
            document.getElementById('startWidth').textContent = level.startWidth + 'px';
            document.getElementById('endWidth').textContent = level.endWidth + 'px';
            
            // åˆå§‹åŒ–è·¯å¾„
            initPath(level);
            
            // é‡ç½®ç©å®¶ä½ç½®
            player.x = 100;
            player.y = 300;
            
            // éšè—æ‰€æœ‰è¦†ç›–å±‚
            document.getElementById('gameOverLayer').style.display = 'none';
            document.getElementById('victoryLayer').style.display = 'none';
            document.getElementById('smileyLayer').style.display = 'none';
        }
        
        // 12. åˆå§‹åŒ–æ‘‡æ†ä½ç½®
        function updateJoystickPosition() {
            const baseRect = joystick.base.getBoundingClientRect();
            joystick.centerX = baseRect.width / 2;
            joystick.centerY = baseRect.height / 2;
            joystick.radius = baseRect.width / 2 - 10;
            joystick.knobRadius = joystick.knob.offsetWidth / 2;
        }
        
        // 13. åˆå§‹åŒ–è·¯å¾„
        function initPath(level) {
            pathSegments = [];
            pathPoints = [];
            
            let x = 50;
            let y = 300;
            let width = level.startWidth;
            const widthStep = (level.startWidth - level.endWidth) / Math.max(1, level.turns.length - 1);
            
            pathPoints.push({x, y});
            
            for (let i = 0; i < level.turns.length; i++) {
                pathPoints.push(level.turns[i]);
                
                // è®¡ç®—å½“å‰æ®µçš„å®½åº¦
                if (i < level.turns.length - 1) {
                    width = Math.max(level.endWidth, width - widthStep);
                } else {
                    width = level.endWidth;
                }
                
                // åˆ›å»ºè·¯å¾„æ®µ
                pathSegments.push({
                    start: {x: pathPoints[i].x, y: pathPoints[i].y},
                    end: {x: level.turns[i].x, y: level.turns[i].y},
                    width: width,
                    index: i
                });
            }
        }
        
        // 14. ç»˜åˆ¶è·¯å¾„
        function drawPath() {
            ctx.strokeStyle = '#ff69b4';
            ctx.fillStyle = 'rgba(255, 182, 193, 0.6)';
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            for (let i = 0; i < pathSegments.length; i++) {
                const segment = pathSegments[i];
                const halfWidth = segment.width / 2;
                
                // è®¡ç®—è·¯å¾„æ–¹å‘
                const dx = segment.end.x - segment.start.x;
                const dy = segment.end.y - segment.start.y;
                const length = Math.sqrt(dx * dx + dy * dy);
                const nx = -dy / length;
                const ny = dx / length;
                
                // ç»˜åˆ¶è·¯å¾„è¾¹ç•Œ
                ctx.beginPath();
                ctx.moveTo(segment.start.x + nx * halfWidth, segment.start.y + ny * halfWidth);
                ctx.lineTo(segment.end.x + nx * halfWidth, segment.end.y + ny * halfWidth);
                ctx.lineTo(segment.end.x - nx * halfWidth, segment.end.y - ny * halfWidth);
                ctx.lineTo(segment.start.x - nx * halfWidth, segment.start.y - ny * halfWidth);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                
                // ç»˜åˆ¶å…¥å£æ ‡è¯†
                if (i === 0) {
                    ctx.fillStyle = '#00ff00';
                    ctx.font = 'bold 20px Arial';
                    ctx.fillText('å…¥å£', segment.start.x - 20, segment.start.y - halfWidth - 10);
                }
                
                // ç»˜åˆ¶å®½åº¦ä¿¡æ¯
                if (i > 0) {
                    ctx.fillStyle = '#d63384';
                    ctx.font = 'bold 12px Arial';
                    ctx.fillText(`${Math.round(segment.width)}px`, (segment.start.x + segment.end.x) / 2 - 15, (segment.start.y + segment.end.y) / 2);
                }
                
                ctx.fillStyle = 'rgba(255, 182, 193, 0.6)';
            }
            
            // ç»˜åˆ¶å‡ºå£åŒºåŸŸ
            if (exitZone) {
                // ç»˜åˆ¶å‡ºå£åŒºåŸŸï¼ˆç²‰è‰²åœ†å½¢ï¼‰
                ctx.fillStyle = 'rgba(255, 105, 180, 0.8)';
                ctx.beginPath();
                ctx.arc(exitZone.x, exitZone.y, exitZone.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // ç»˜åˆ¶å‡ºå£æ–‡å­—
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('å‡ºå£', exitZone.x, exitZone.y + 5);
                ctx.textAlign = 'left';
            }
        }
        
        // 15. ç»˜åˆ¶ç©å®¶
        function drawPlayer() {
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(player.x - player.size, player.y - player.size, player.size * 2, player.size * 2);
            ctx.strokeStyle = '#FFA000';
            ctx.lineWidth = 1;
            ctx.strokeRect(player.x - player.size, player.y - player.size, player.size * 2, player.size * 2);
        }
        
        // 16. æ£€æŸ¥ç©å®¶ä½ç½®å¹¶è§¦å‘ç¬‘è„¸
        function checkPlayerPosition() {
            if (gameOver || victory) return;
            
            for (let i = 0; i < pathSegments.length; i++) {
                const segment = pathSegments[i];
                
                // è®¡ç®—ç©å®¶åœ¨çº¿æ®µä¸Šçš„ä½ç½®
                const dx = segment.end.x - segment.start.x;
                const dy = segment.end.y - segment.start.y;
                const length = Math.sqrt(dx * dx + dy * dy);
                
                // è®¡ç®—ç©å®¶åœ¨çº¿æ®µä¸Šçš„æŠ•å½±
                const t = Math.max(0, Math.min(1, ((player.x - segment.start.x) * dx + (player.y - segment.start.y) * dy) / (length * length)));
                const projX = segment.start.x + t * dx;
                const projY = segment.start.y + t * dy;
                const dist = Math.sqrt((player.x - projX) * (player.x - projX) + (player.y - projY) * (player.y - projY));
                
                // æ£€æŸ¥ç©å®¶æ˜¯å¦åœ¨è¯¥è·¯å¾„æ®µå†…
                if (dist <= segment.width / 2 - player.size - 1) {
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘ç¬‘è„¸
                    checkSmileyTrigger(segment, t, i);
                }
            }
        }
        
        // 17. æ£€æŸ¥ç¬‘è„¸è§¦å‘æ¡ä»¶
        function checkSmileyTrigger(segment, position, segmentIndex) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»è§¦å‘è¿‡è¿™ä¸ªè·¯æ®µçš„ç¬‘è„¸
            const triggerKey = `segment_${segmentIndex}`;
            if (smileyTriggers.includes(triggerKey)) return;
            
            let shouldTrigger = false;
            
            // æ¡ä»¶1: 25pxè·¯æ®µçš„ä¸­é—´ä½ç½®
            if (segment.width === 25 && position >= 0.4 && position <= 0.6) shouldTrigger = true;
            
            // æ¡ä»¶2: â‰¤20pxè·¯æ®µçš„1/3ä½ç½®
            if (segment.width <= NARROW_WIDTH_THRESHOLD && position >= 0.25 && position <= 0.4) {
                shouldTrigger = true;
            }
            
            // æ¡ä»¶3: æœ€ç»ˆè·¯æ®µä¹Ÿè§¦å‘ç¬‘è„¸
            if (segment.width <= FINAL_SEGMENT_WIDTH && position >= 0.4 && position <= 0.6) {
                shouldTrigger = true;
            }
            
            if (shouldTrigger) {
                showSmiley();
                smileyTriggers.push(triggerKey);
            }
        }
        
        // 18. æ˜¾ç¤ºçº¢è‰²ç¬‘è„¸
        function showSmiley() {
            const smileyLayer = document.getElementById('smileyLayer');
            smileyLayer.style.display = 'flex';
            
            // 2ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                smileyLayer.style.display = 'none';
            }, 2000);
        }
        
        // 19. æ£€æŸ¥ç©å®¶æ˜¯å¦åœ¨è·¯å¾„å†…
        function checkPlayerCollision() {
            // æ£€æŸ¥è¾¹ç•Œ
            if (player.x - player.size < 0 || player.x + player.size > canvas.width ||
                player.y - player.size < 0 || player.y + player.size > canvas.height) {
                return true;
            }
            
            let inPath = false;
            for (let segment of pathSegments) {
                const dx = segment.end.x - segment.start.x;
                const dy = segment.end.y - segment.start.y;
                const length = Math.sqrt(dx * dx + dy * dy);
                
                // è®¡ç®—ç©å®¶åœ¨çº¿æ®µä¸Šçš„æŠ•å½±
                const t = Math.max(0, Math.min(1, ((player.x - segment.start.x) * dx + (player.y - segment.start.y) * dy) / (length * length)));
                const projX = segment.start.x + t * dx;
                const projY = segment.start.y + t * dy;
                const dist = Math.sqrt((player.x - projX) * (player.x - projX) + (player.y - projY) * (player.y - projY));
                
                // ä½¿ç”¨ç²¾ç¡®ç¢°æ’æ£€æµ‹
                if (dist <= segment.width / 2 - player.size - 1) {
                    inPath = true;
                    break;
                }
            }
            
            return !inPath;
        }
        
        // 20. æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å‡ºå£
        function checkExitReached() {
            if (!exitZone) return false;
            
            const dist = Math.sqrt(
                (player.x - exitZone.x) * (player.x - exitZone.x) + 
                (player.y - exitZone.y) * (player.y - exitZone.y)
            );
            
            return dist <= exitZone.radius;
        }
        
        // 21. æ›´æ–°ç©å®¶ä½ç½®
        function updatePlayer() {
            if (gameOver || victory) return;
            
            let newX = player.x;
            let newY = player.y;
            
            // é”®ç›˜æ§åˆ¶
            if (keys['ArrowUp']) newY -= player.speed;
            if (keys['ArrowDown']) newY += player.speed;
            if (keys['ArrowLeft']) newX -= player.speed;
            if (keys['ArrowRight']) newX += player.speed;
            
            // æ‘‡æ†æ§åˆ¶
            if (joystick.active) {
                newX += joystick.deltaX * player.speed * 0.01;
                newY += joystick.deltaY * player.speed * 0.01;
            }
            
            // ä¿å­˜æ—§ä½ç½®
            const oldX = player.x;
            const oldY = player.y;
            
            // å°è¯•ç§»åŠ¨
            player.x = newX;
            player.y = newY;
            
            // æ£€æŸ¥ç¢°æ’
            if (checkPlayerCollision()) {
                gameOver = true;
                document.getElementById('gameOverLayer').style.display = 'flex';
                return;
            }
            
            // æ£€æŸ¥ç©å®¶ä½ç½®ï¼ˆè§¦å‘ç¬‘è„¸ï¼‰
            checkPlayerPosition();
            
            // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å‡ºå£
            if (checkExitReached()) {
                victory = true;
                document.getElementById('currentLevelNum').textContent = currentLevel;
                document.getElementById('victoryLayer').style.display = 'flex';
                
                // ä¿å­˜è¿›åº¦
                saveProgress();
            }
        }
        
        // 22. é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            startLevel(currentLevel);
        }
        
        // 23. ä¸‹ä¸€å…³
        function nextLevel() {
            if (currentLevel < 20) {
                startLevel(currentLevel + 1);
            } else {
                backToLevelSelect();
            }
        }
        
        // 24. è¿”å›å…³å¡é€‰æ‹©
        function backToLevelSelect() {
            document.getElementById('levelSelectLayer').style.display = 'flex';
            document.getElementById('gameOverLayer').style.display = 'none';
            document.getElementById('victoryLayer').style.display = 'none';
            initLevelSelect();
        }
        
        // 25. æ‘‡æ†äº‹ä»¶å¤„ç†
        function handleJoystickStart(e) {
            e.preventDefault();
            joystick.active = true;
            updateJoystickPosition();
            handleJoystickMove(e);
        }
        
        function handleJoystickMove(e) {
            if (!joystick.active) return;
            e.preventDefault();
            
            const touch = e.touches ? e.touches[0] : e;
            const baseRect = joystick.base.getBoundingClientRect();
            const centerX = baseRect.left + baseRect.width / 2;
            const centerY = baseRect.top + baseRect.height / 2;
            
            let deltaX = touch.clientX - centerX;
            let deltaY = touch.clientY - centerY;
            
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const maxDistance = joystick.radius;
            
            if (distance > maxDistance) {
                deltaX = (deltaX / distance) * maxDistance;
                deltaY = (deltaY / distance) * maxDistance;
            }
            
            joystick.deltaX = deltaX;
            joystick.deltaY = deltaY;
            joystick.knob.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
        }
        
        function handleJoystickEnd(e) {
            e.preventDefault();
            joystick.active = false;
            joystick.deltaX = 0;
            joystick.deltaY = 0;
            joystick.knob.style.transform = 'translate(0, 0)';
        }
        
        // 26. æ¸¸æˆå¾ªç¯
        function gameLoop() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#fff5f8';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = 'rgba(255, 182, 193, 0.2)';
            ctx.lineWidth = 0.5;
            for (let i = 0; i < canvas.width; i += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i < canvas.height; i += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶è·¯å¾„å’Œç©å®¶
            drawPath();
            if (!gameOver && !victory) {
                drawPlayer();
            }
            
            // æ›´æ–°ç©å®¶
            updatePlayer();
            
            requestAnimationFrame(gameLoop);
        }
        
        // 27. é”®ç›˜äº‹ä»¶
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });
        
        // 28. è§¦æ‘¸äº‹ä»¶
        const joystickContainer = document.getElementById('joystickContainer');
        joystickContainer.addEventListener('touchstart', handleJoystickStart, {passive: false});
        joystickContainer.addEventListener('touchmove', handleJoystickMove, {passive: false});
        joystickContainer.addEventListener('touchend', handleJoystickEnd, {passive: false});
        
        // 29. é¼ æ ‡äº‹ä»¶ï¼ˆç”¨äºæµ‹è¯•ï¼‰
        joystickContainer.addEventListener('mousedown', handleJoystickStart);
        window.addEventListener('mousemove', handleJoystickMove);
        window.addEventListener('mouseup', handleJoystickEnd);
        
        // 30. çª—å£å¤§å°æ”¹å˜æ—¶æ›´æ–°æ‘‡æ†
        window.addEventListener('resize', updateJoystickPosition);
        
        // 31. åˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // åˆå§‹åŒ–æ•°æ®åº“
                await IDB.init();
                console.log('æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
                
                // åˆå§‹åŒ–å…³å¡é€‰æ‹©ç•Œé¢
                await initLevelSelect();
                
                // åˆå§‹åŒ–æ‘‡æ†ä½ç½®
                updateJoystickPosition();
                
                // å¼€å§‹æ¸¸æˆå¾ªç¯
                gameLoop();
                
            } catch (error) {
                console.error('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
            }
        });
    </script>
    
    <!-- æ•°æ®åº“ç®¡ç†å™¨ -->
    <script>
        // ===============================================
        // ===== ä¸€IndexedDB æ•°æ®åº“ç®¡ç†å™¨=====
        // æ–‡ä»¶æ‰€åœ¨ä½ç½® /db.js
        // ===============================================
        window.IDB = {
            // æ•°æ®åº“é…ç½®
            DB_NAME: 'LiangAnUserCenterDB',
            VERSION: 1,
            STORES: {
                configs: 'configs', // é…ç½®æ•°æ®åŒº
                userdata: 'userdata', // ç”¨æˆ·æ•°æ®åŒº
                official: 'official' // å®˜æ–¹æ•°æ®åŒº
            },
            db: null,
            initPromise: null,
            
            // -----------------------------------------------------
            // 1. åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
            // -----------------------------------------------------
            async init() {
                if (this.initPromise) return this.initPromise;
                
                this.initPromise = new Promise((resolve, reject) => {
                    console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...');
                    
                    const request = indexedDB.open(this.DB_NAME, this.VERSION);
                    
                    request.onerror = () => {
                        const error = request.error;
                        console.error('âŒ æ•°æ®åº“æ‰“å¼€å¤±è´¥:', error);
                        reject(error);
                    };
                    
                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (e) => {
                        console.log('ğŸ”„ æ•°æ®åº“å‡çº§ä¸­...');
                        const db = e.target.result;
                        
                        // åˆ›å»ºä¸‰ä¸ªå­˜å‚¨åŒº
                        if (!db.objectStoreNames.contains(this.STORES.configs)) {
                            db.createObjectStore(this.STORES.configs);
                            console.log('ğŸ“ åˆ›å»ºconfigså­˜å‚¨');
                        }
                        
                        if (!db.objectStoreNames.contains(this.STORES.userdata)) {
                            db.createObjectStore(this.STORES.userdata);
                            console.log('ğŸ“ åˆ›å»ºuserdataå­˜å‚¨');
                        }
                        
                        if (!db.objectStoreNames.contains(this.STORES.official)) {
                            db.createObjectStore(this.STORES.official);
                            console.log('ğŸ“ åˆ›å»ºofficialå­˜å‚¨');
                        }
                        
                        console.log('âœ… æ•°æ®åº“å‡çº§å®Œæˆ');
                    };
                });
                
                return this.initPromise;
            },
            
            // -----------------------------------------------------
            // 2. æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å¯ç”¨
            // -----------------------------------------------------
            async isAvailable() {
                try {
                    await this.init();
                    return true;
                } catch (error) {
                    console.error('âŒ æ•°æ®åº“ä¸å¯ç”¨:', error);
                    return false;
                }
            },
            
            // -----------------------------------------------------
            // 3. å‘æ•°æ®åº“å­˜å‚¨æ•°æ®
            // -----------------------------------------------------
            async put(key, value, store = 'configs') {
                try {
                    await this.init();
                    console.log(`ğŸ’¾ å­˜å‚¨åˆ°æ•°æ®åº“: ${key} (å­˜å‚¨åŒº: ${store})`);
                    
                    return new Promise((resolve) => {
                        const tx = this.db.transaction([this.STORES[store]], 'readwrite');
                        const objectStore = tx.objectStore(this.STORES[store]);
                        const request = objectStore.put(value, key);
                        
                        request.onsuccess = () => {
                            console.log(`âœ… æ•°æ®åº“å­˜å‚¨æˆåŠŸ: ${key}`);
                            resolve();
                        };
                        
                        request.onerror = () => {
                            console.error(`âŒ æ•°æ®åº“å­˜å‚¨å¤±è´¥: ${key}`);
                            resolve();
                        };
                    });
                } catch (error) {
                    console.error('âŒ æ•°æ®åº“å­˜å‚¨å¼‚å¸¸:', error);
                }
            },
            
            // -----------------------------------------------------
            // 4. åˆ é™¤æ•°æ®åº“ä¸­çš„æ•°æ®
            // -----------------------------------------------------
            async delete(key, store = 'configs') {
                try {
                    await this.init();
                    console.log(`ğŸ—‘ï¸ åˆ é™¤æ•°æ®åº“æ•°æ®: ${key} (å­˜å‚¨åŒº: ${store})`);
                    
                    return new Promise((resolve) => {
                        const tx = this.db.transaction([this.STORES[store]], 'readwrite');
                        const objectStore = tx.objectStore(this.STORES[store]);
                        const request = objectStore.delete(key);
                        
                        request.onsuccess = () => {
                            console.log(`âœ… æ•°æ®åº“åˆ é™¤æˆåŠŸ: ${key}`);
                            resolve(true);
                        };
                        
                        request.onerror = () => {
                            console.error(`âŒ æ•°æ®åº“åˆ é™¤å¤±è´¥: ${key}`);
                            resolve(false);
                        };
                    });
                } catch (error) {
                    console.error('âŒ æ•°æ®åº“åˆ é™¤å¼‚å¸¸:', error);
                    return false;
                }
            },
            
            // -----------------------------------------------------
            // 5. ä»æ•°æ®åº“è·å–æ•°æ®
            // -----------------------------------------------------
            async get(key, store = 'configs') {
                try {
                    await this.init();
                    console.log(`ğŸ” æŸ¥è¯¢æ•°æ®åº“: ${key} (å­˜å‚¨åŒº: ${store})`);
                    
                    return new Promise((resolve) => {
                        const tx = this.db.transaction([this.STORES[store]], 'readonly');
                        const objectStore = tx.objectStore(this.STORES[store]);
                        const request = objectStore.get(key);
                        
                        request.onsuccess = () => {
                            const result = request.result;
                            if (result) {
                                console.log(`ğŸ¯ æ•°æ®åº“å‘½ä¸­: ${key}`);
                            } else {
                                console.log(`âŒ æ•°æ®åº“æœªå‘½ä¸­: ${key}`);
                            }
                            resolve(result);
                        };
                        
                        request.onerror = () => {
                            console.error(`âŒ æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: ${key}`);
                            resolve(null);
                        };
                    });
                } catch (error) {
                    console.error('âŒ æ•°æ®åº“è·å–å¼‚å¸¸:', error);
                    return null;
                }
            }
        };
        
        // ===============================================
        // ===== äºŒBase64 åŠ å¯†è§£å¯†å·¥å…·=====
        // ===============================================
        const Base64 = {
            // -----------------------------------------------------
            // 6. Base64 ç¼–ç 
            // -----------------------------------------------------
            encode: function(str) {
                try {
                    return btoa(unescape(encodeURIComponent(str)));
                } catch (error) {
                    console.error('âŒ Base64ç¼–ç å¤±è´¥:', error);
                    return null;
                }
            },
            
            // -----------------------------------------------------
            // 7. Base64 è§£ç 
            // -----------------------------------------------------
            decode: function(str) {
                try {
                    return decodeURIComponent(escape(atob(str)));
                } catch (error) {
                    console.error('âŒ Base64è§£ç å¤±è´¥:', error);
                    return null;
                }
            }
        };
        
        // ===============================================
        // ===== ä¸‰æ•°æ®å¯¼å…¥å¯¼å‡ºç®¡ç†å™¨=====
        // ===============================================
        IDB.DataManager = {
            // -----------------------------------------------------
            // 8. å¯¼å‡ºæ•°æ®
            // -----------------------------------------------------
            async exportData(account, password, includeUserData = true, includeConfigs = false) {
                try {
                    console.log('ğŸ“¤ å¼€å§‹å¯¼å‡ºæ•°æ®...');
                    
                    // éªŒè¯è´¦å·å¯†ç 
                    if (!account || !password) {
                        throw new Error('è´¦å·å’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                    }
                    
                    // è·å–ç”¨æˆ·æ•°æ®
                    const exportData = {
                        account: Base64.encode(account),
                        password: Base64.encode(password),
                        exportDate: new Date().toISOString(),
                        version: '1.0',
                        data: {}
                    };
                    
                    // å¯¼å‡ºç”¨æˆ·æ•°æ®
                    if (includeUserData) {
                        const userData = await this.getAllStoreData('userdata');
                        exportData.data.userdata = userData;
                    }
                    
                    // å¯¼å‡ºé…ç½®æ•°æ®
                    if (includeConfigs) {
                        const configData = await this.getAllStoreData('configs');
                        exportData.data.configs = configData;
                    }
                    
                    console.log('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸ');
                    return exportData;
                } catch (error) {
                    console.error('âŒ æ•°æ®å¯¼å‡ºå¤±è´¥:', error);
                    throw error;
                }
            },
            
            // -----------------------------------------------------
            // 9. å¯¼å…¥æ•°æ®
            // -----------------------------------------------------
            async importData(jsonData, account, password, overwrite = false) {
                try {
                    console.log('ğŸ“¥ å¼€å§‹å¯¼å…¥æ•°æ®...');
                    
                    // éªŒè¯è´¦å·å¯†ç 
                    if (!account || !password) {
                        throw new Error('è´¦å·å’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                    }
                    
                    // è§£æJSONæ•°æ®
                    let importData;
                    if (typeof jsonData === 'string') {
                        importData = JSON.parse(jsonData);
                    } else {
                        importData = jsonData;
                    }
                    
                    // éªŒè¯å¯¼å…¥æ•°æ®æ ¼å¼
                    if (!importData.account || !importData.password || !importData.data) {
                        throw new Error('å¯¼å…¥æ•°æ®æ ¼å¼é”™è¯¯');
                    }
                    
                    // éªŒè¯è´¦å·å¯†ç 
                    const decodedAccount = Base64.decode(importData.account);
                    const decodedPassword = Base64.decode(importData.password);
                    
                    if (decodedAccount !== account || decodedPassword !== password) {
                        throw new Error('è´¦å·æˆ–å¯†ç ä¸æ­£ç¡®');
                    }
                    
                    // å¯¼å…¥ç”¨æˆ·æ•°æ®
                    if (importData.data.userdata) {
                        await this.importStoreData('userdata', importData.data.userdata, overwrite);
                    }
                    
                    // å¯¼å…¥é…ç½®æ•°æ®
                    if (importData.data.configs) {
                        await this.importStoreData('configs', importData.data.configs, overwrite);
                    }
                    
                    console.log('âœ… æ•°æ®å¯¼å…¥æˆåŠŸ');
                    return true;
                } catch (error) {
                    console.error('âŒ æ•°æ®å¯¼å…¥å¤±è´¥:', error);
                    throw error;
                }
            },
            
            // -----------------------------------------------------
            // 10. è·å–å­˜å‚¨åŒºæ‰€æœ‰æ•°æ®
            // -----------------------------------------------------
            async getAllStoreData(store) {
                try {
                    await IDB.init();
                    
                    return new Promise((resolve) => {
                        const tx = IDB.db.transaction([IDB.STORES[store]], 'readonly');
                        const objectStore = tx.objectStore(IDB.STORES[store]);
                        const request = objectStore.getAll();
                        
                        request.onsuccess = () => {
                            const items = request.result;
                            const data = {};
                            
                            // ä½¿ç”¨æ¸¸æ ‡è·å–é”®å€¼å¯¹
                            const cursorRequest = objectStore.openCursor();
                            
                            cursorRequest.onsuccess = (e) => {
                                const cursor = e.target.result;
                                if (cursor) {
                                    // ç›´æ¥å­˜å‚¨é”®å€¼å¯¹ï¼Œä¸å­˜å‚¨JavaScriptä»£ç 
                                    data[cursor.key] = cursor.value;
                                    cursor.continue();
                                } else {
                                    console.log(`ğŸ“‹ ${store}å­˜å‚¨åŒºæ•°æ®:`, data);
                                    resolve(data);
                                }
                            };
                            
                            cursorRequest.onerror = () => {
                                console.error(`âŒ è·å–${store}æ•°æ®å¤±è´¥`);
                                resolve({});
                            };
                        };
                        
                        request.onerror = () => {
                            console.error(`âŒ è·å–${store}æ•°æ®å¤±è´¥`);
                            resolve({});
                        };
                    });
                } catch (error) {
                    console.error('âŒ è·å–å­˜å‚¨åŒºæ•°æ®å¼‚å¸¸:', error);
                    return {};
                }
            },
            
            // -----------------------------------------------------
            // 11. å¯¼å…¥å­˜å‚¨åŒºæ•°æ®
            // -----------------------------------------------------
            async importStoreData(store, data, overwrite = false) {
                try {
                    await IDB.init();
                    
                    for (const [key, value] of Object.entries(data)) {
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                        if (!overwrite) {
                            const existing = await IDB.get(key, store);
                            if (existing) {
                                console.log(`âš ï¸ è·³è¿‡å·²å­˜åœ¨çš„é”®: ${key}`);
                                continue;
                            }
                        }
                        
                        // ç›´æ¥å­˜å‚¨JSONå¯¹è±¡ï¼Œä¸åŒ…è£…ä¸ºJavaScriptä»£ç 
                        await IDB.put(key, value, store);
                        console.log(`âœ… å·²å¯¼å…¥${key}åˆ°${store}å­˜å‚¨åŒº`);
                    }
                    
                    console.log(`âœ… ${store}æ•°æ®å¯¼å…¥å®Œæˆ`);
                } catch (error) {
                    console.error(`âŒ ${store}æ•°æ®å¯¼å…¥å¼‚å¸¸:`, error);
                    throw error;
                }
            },
            
            // -----------------------------------------------------
            // 12. ä¸‹è½½å¯¼å‡ºæ–‡ä»¶
            // -----------------------------------------------------
            downloadExportFile(exportData, filename) {
                try {
                    const dataStr = JSON.stringify(exportData);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = filename || `export_${Date.now()}.json`;
                    link.click();
                    console.log('âœ… å¯¼å‡ºæ–‡ä»¶ä¸‹è½½æˆåŠŸ');
                } catch (error) {
                    console.error('âŒ ä¸‹è½½å¯¼å‡ºæ–‡ä»¶å¤±è´¥:', error);
                    throw error;
                }
            },
            
            // -----------------------------------------------------
            // 13. è¯»å–å¯¼å…¥æ–‡ä»¶
            // -----------------------------------------------------
            readImportFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            resolve(jsonData);
                        } catch (error) {
                            reject(new Error('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œä¸æ˜¯æœ‰æ•ˆçš„JSON'));
                        }
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                    };
                    
                    reader.readAsText(file);
                });
            }
        };
        
        // ===============================================
        // ===== å››ç¼“å­˜ç®¡ç†å™¨=====
        // ===============================================
        IDB.cacheLocalFile = function(fileName, store = 'configs') {
            // -----------------------------------------------------
            // 14. ç¼“å­˜æœ¬åœ°æ–‡ä»¶
            // -----------------------------------------------------
            if (!fileName) {
                console.warn('âš ï¸ æ–‡ä»¶åä¸ºç©º');
                return;
            }
            
            console.log(`ğŸ“ å¼€å§‹ç¼“å­˜æ–‡ä»¶: ${fileName}`);
            
            try {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', fileName, false); // åŒæ­¥
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200 || xhr.status === 0) {
                            // å­˜å‚¨åˆ°æ•°æ®åº“
                            IDB.put(fileName, xhr.responseText, store).then(() => {
                                console.log(`âœ… æ–‡ä»¶ç¼“å­˜æˆåŠŸ: ${fileName}`);
                            }).catch(error => {
                                console.error(`âŒ æ–‡ä»¶ç¼“å­˜å¤±è´¥: ${fileName}`, error);
                            });
                        } else {
                            console.error(`âŒ æ–‡ä»¶è¯»å–å¤±è´¥: ${fileName} (çŠ¶æ€: ${xhr.status})`);
                        }
                    }
                };
                
                xhr.onerror = function() {
                    console.error(`âŒ æ–‡ä»¶è¯·æ±‚å¤±è´¥: ${fileName}`);
                };
                
                xhr.send();
            } catch (error) {
                console.error(`âŒ æ–‡ä»¶ç¼“å­˜å¼‚å¸¸: ${fileName}`, error);
            }
        };
        
        // ===============================================
        // ===== äº”ç¦»çº¿ç¼“å­˜ç®¡ç†å™¨=====
        // ===============================================
        IDB.CacheMgr = {
            // -----------------------------------------------------
            // 15. è·å–æ–‡ä»¶ï¼ˆä¼˜å…ˆä»ç¼“å­˜ï¼‰
            // -----------------------------------------------------
            async get(file) {
                console.log(`ğŸ” å°è¯•åŠ è½½æ–‡ä»¶: ${file}`);
                
                try {
                    // â‘ ä¼˜å…ˆè¯»åº“
                    const txt = await IDB.get(file, 'configs');
                    if (txt) {
                        console.log(`âš¡ æ•°æ®åº“å‘½ä¸­: ${file}`);
                        return txt;
                    }
                    
                    console.log(`âŒ æ•°æ®åº“æœªå‘½ä¸­ï¼Œå¼€å§‹ç½‘ç»œè¯·æ±‚: ${file}`);
                    
                    // â‘¡åº“æ²¡æœ‰æ‰fetch
                    const resp = await fetch(file);
                    if (!resp.ok) {
                        const errorMsg = `æ–‡ä»¶åŠ è½½å¤±è´¥: ${file} (çŠ¶æ€: ${resp.status})`;
                        console.error(`âŒ ${errorMsg}`);
                        throw new Error(errorMsg);
                    }
                    
                    const text = await resp.text();
                    console.log(`âœ… æ–‡ä»¶åŠ è½½æˆåŠŸï¼Œå¤§å°: ${text.length}å­—ç¬¦`);
                    
                    // â‘¢ç«‹å³å†™åº“
                    await IDB.put(file, text, 'configs');
                    console.log(`ğŸ’¾ æ–‡ä»¶å·²ç¼“å­˜åˆ°æ•°æ®åº“: ${file}`);
                    
                    return text;
                } catch (error) {
                    console.error(`âŒ æ–‡ä»¶åŠ è½½å¤±è´¥: ${file}`, error);
                    throw error;
                }
            }
        };
        
        // ===============================================
        // ===== å…­è‡ªåŠ¨åˆå§‹åŒ–å’Œé”™è¯¯å¤„ç†=====
        // ===============================================
        // -----------------------------------------------------
        // 16. è‡ªåŠ¨åˆå§‹åŒ–å’Œé”™è¯¯å¤„ç†
        // -----------------------------------------------------
        (async function() {
            try {
                console.log('ğŸš€ å¼€å§‹è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“...');
                await IDB.init();
                console.log('âœ… æ•°æ®åº“å…¬å…±åº“åŠ è½½å®Œæˆ');
                
                // æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
                const isAvailable = await IDB.isAvailable();
                if (isAvailable) {
                    console.log('âœ… æ•°æ®åº“çŠ¶æ€æ­£å¸¸');
                } else {
                    console.warn('âš ï¸ æ•°æ®åº“çŠ¶æ€å¼‚å¸¸');
                }
            } catch (error) {
                console.error('âŒ æ•°æ®åº“å…¬å…±åº“åŠ è½½å¤±è´¥:', error);
                console.error('âŒ é”™è¯¯è¯¦æƒ…:', error.message);
                console.error('âŒ é”™è¯¯å †æ ˆ:', error.stack);
                
                // å‘é¡µé¢ä¼ é€’é”™è¯¯ä¿¡æ¯
                if (typeof window !== 'undefined') {
                    window.IDB_ERROR = {
                        message: error.message,
                        stack: error.stack,
                        timestamp: new Date().toISOString()
                    };
                }
            }
        })();
        
        // ===============================================
        // ===== ä¸ƒè°ƒè¯•å·¥å…·=====
        // ===============================================
        IDB.debug = {
            // -----------------------------------------------------
            // 17. è·å–æ•°æ®åº“ä¿¡æ¯
            // -----------------------------------------------------
            async getInfo() {
                try {
                    await IDB.init();
                    return {
                        name: IDB.DB_NAME,
                        version: IDB.VERSION,
                        stores: Object.keys(IDB.STORES),
                        db: IDB.db ? 'å·²è¿æ¥' : 'æœªè¿æ¥'
                    };
                } catch (error) {
                    return { error: error.message };
                }
            },
            
            // -----------------------------------------------------
            // 18. æ¸…ç©ºæ•°æ®åº“
            // -----------------------------------------------------
            async clear(store = 'configs') {
                try {
                    await IDB.init();
                    const tx = IDB.db.transaction([IDB.STORES[store]], 'readwrite');
                    const objectStore = tx.objectStore(IDB.STORES[store]);
                    await objectStore.clear();
                    console.log(`ğŸ—‘ï¸ ${store}æ•°æ®åº“å·²æ¸…ç©º`);
                    return true;
                } catch (error) {
                    console.error(`âŒ æ¸…ç©º${store}æ•°æ®åº“å¤±è´¥:`, error);
                    return false;
                }
            },
            
            // -----------------------------------------------------
            // 19. åˆ—å‡ºæ‰€æœ‰ç¼“å­˜
            // -----------------------------------------------------
            async listAll(store = 'configs') {
                try {
                    await IDB.init();
                    const tx = IDB.db.transaction([IDB.STORES[store]], 'readonly');
                    const objectStore = tx.objectStore(IDB.STORES[store]);
                    
                    return new Promise((resolve) => {
                        const cursorRequest = objectStore.openCursor();
                        const items = [];
                        
                        cursorRequest.onsuccess = (e) => {
                            const cursor = e.target.result;
                            if (cursor) {
                                items.push({
                                    key: cursor.key,
                                    value: cursor.value
                                });
                                cursor.continue();
                            } else {
                                console.log(`ğŸ“‹ ${store}æ•°æ®åº“å†…å®¹:`, items);
                                resolve(items);
                            }
                        };
                        
                        cursorRequest.onerror = () => {
                            console.error(`âŒ è·å–${store}æ•°æ®åº“å†…å®¹å¤±è´¥`);
                            resolve([]);
                        };
                    });
                } catch (error) {
                    console.error(`âŒ åˆ—å‡º${store}ç¼“å­˜å¤±è´¥:`, error);
                    return [];
                }
            }
        };
        
        // ===============================================
        // ===== å¯¼å‡ºåˆ°å…¨å±€ï¼Œä¾¿äºè°ƒè¯•=====
        // ===============================================
        if (typeof window !== 'undefined') {
            window.IDB_DEBUG = IDB.debug;
            window.IDB_DataManager = IDB.DataManager;
        }
    </script>
</body>
</html>
