<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è„šæœ¬ä¸­å¿ƒ- ä»£ç æŸ¥çœ‹å™¨</title>
<!-- é»˜è®¤é«˜äº®ä¸»é¢˜ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" id="prism-theme">
<style>
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
    --accent-color: #f093fb;
    --code-bg: #0f172a;
    --text-color: #e2e8f0;
    --border-color: #334155;
    --card-bg: rgba(255, 255, 255, 0.08);
    --base-font-size: 14px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
    background:
        radial-gradient(circle at 15% 25%, rgba(102, 126, 234, 0.4) 0%, transparent 50%),
        radial-gradient(circle at 85% 75%, rgba(118, 75, 162, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(240, 147, 251, 0.2) 0%, transparent 50%),
        linear-gradient(135deg, #0f172a 0%, #1e293b 30%, #334155 100%);
    min-height: 100vh;
    color: var(--text-color);
    position: relative;
    overflow: hidden;
}

/* åŠ¨æ€èƒŒæ™¯æ•ˆæœ*/
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background:
        radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.1) 2px, transparent 2px),
        radial-gradient(circle at 80% 70%, rgba(240, 147, 251, 0.1) 1px, transparent 1px),
        radial-gradient(circle at 50% 50%, rgba(118, 75, 162, 0.1) 1.5px, transparent 1.5px);
    background-size: 60px 60px, 40px 40px, 50px 50px;
    animation: backgroundFloat 25s linear infinite;
    z-index: 0;
}

@keyframes backgroundFloat {
    0% { transform: translate(0, 0) rotate(0deg); }
    100% { transform: translate(30px, 30px) rotate(360deg); }
}

.container {
    position: relative;
    z-index: 1;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.header {
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(20px);
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header h1 {
    font-size: 22px;
    font-weight: 600;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color), var(--accent-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.main-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 20px;
    max-width: 100%;
}

/* è¾“å…¥åŒºåŸŸ*/
.input-section {
    background: var(--card-bg);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.input-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.input-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-color);
}

.control-panel {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.control-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
}

.control-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.control-btn:active {
    transform: translateY(0);
}

.control-btn.active {
    background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
    box-shadow: 0 0 10px rgba(240, 147, 251, 0.5);
}

.code-input {
    width: 100%;
    min-height: 200px;
    background: rgba(15, 23, 42, 0.8);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 15px;
    color: var(--text-color);
    font-family: 'Fira Code', 'Courier New', monospace;
    font-size: var(--base-font-size);
    line-height: 1.5;
    resize: vertical;
    outline: none;
    transition: all 0.3s ease;
}

.code-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* ä»£ç å±•ç¤ºåŒºåŸŸ*/
.code-view {
    display: none;
    flex: 1;
    flex-direction: column;
}

.code-view.active {
    display: flex;
}

/* å…¨å±ä»£ç æŸ¥çœ‹æ ·å¼ */
.code-view.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 999;
    background: var(--code-bg);
}

.code-view.fullscreen .code-container {
    height: 100vh;
    max-height: 100vh;
    padding: 15px;
    overflow: auto;
    border: none;
    border-radius: 0;
}

.code-view.fullscreen .code-header {
    display: none;
}

/* æµ®åŠ¨æ§åˆ¶æŒ‰é’® */
.floating-controls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 8px;
    z-index: 1000;
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(10px);
    padding: 8px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    flex-wrap: wrap;
    max-width: 300px;
}

.floating-controls .control-btn {
    padding: 6px 10px;
    font-size: 10px;
    background: rgba(102, 126, 234, 0.8);
}

.floating-controls .control-btn:hover {
    background: rgba(102, 126, 234, 1);
}

.code-header {
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(20px);
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.code-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
}

.code-controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.code-container {
    flex: 1;
    background: var(--code-bg);
    border-radius: 12px;
    overflow: auto;
    max-height: calc(100vh - 200px);
    border: 1px solid var(--border-color);
}

/* ä»£ç å­—ä½“å¤§å°æ§åˆ¶ */
pre[class*="language-"], .code-input {
    font-size: var(--base-font-size);
    transition: font-size 0.3s ease;
}

.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    color: #94a3b8;
}

.toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 14px;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.toast.show {
    opacity: 1;
}

.orientation-notice {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    z-index: 10000;
    display: none;
    max-width: 400px;
}

.orientation-notice.show {
    display: block;
    animation: fadeIn 0.3s ease;
}

.orientation-notice h3 {
    margin-bottom: 15px;
    font-size: 20px;
}

.orientation-notice p {
    margin-bottom: 20px;
    line-height: 1.5;
}

/* æ³¨é‡Šæç¤ºæ ·å¼ */
.comment-hint {
    background: rgba(102, 126, 234, 0.1);
    border-left: 3px solid var(--primary-color);
    padding: 12px 15px;
    margin: 10px 0;
    border-radius: 0 8px 8px 0;
    font-size: 13px;
    color: #a5b4fc;
    animation: slideIn 0.5s ease;
}

@keyframes slideIn {
    from { 
        opacity: 0; 
        transform: translateX(-20px); 
    }
    to { 
        opacity: 1; 
        transform: translateX(0); 
    }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

/* æ‰‹æœºé€‚é…*/
@media (max-width: 768px) {
    .main-container {
        padding: 15px;
    }
    
    .header h1 {
        font-size: 18px;
    }
    
    .control-btn {
        padding: 6px 10px;
        font-size: 10px;
    }
    
    .code-input {
        font-size: var(--base-font-size);
        padding: 12px;
        min-height: 150px;
    }
    
    pre[class*="language-"] {
        font-size: var(--base-font-size);
        padding: 15px;
    }
    
    .floating-controls {
        bottom: 15px;
        right: 15px;
        padding: 6px;
        max-width: 250px;
    }
    
    .floating-controls .control-btn {
        padding: 5px 8px;
        font-size: 9px;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ¨è„šæœ¬ä¸­å¿ƒ- ä»£ç æŸ¥çœ‹å™¨</h1>
    </div>
    <div class="main-container">
        <!-- è¾“å…¥åŒºåŸŸ-->
        <div class="input-section" id="inputSection">
            <div class="input-header">
                <div class="input-title">ğŸ“è¾“å…¥ä»£ç </div>
                <div class="control-panel">
                    <button class="control-btn" onclick="adjustZoom(-2)">ğŸ”- ç¼©å°</button>
                    <button class="control-btn" onclick="adjustZoom(2)">ğŸ”+ æ”¾å¤§</button>
                    <button class="control-btn" onclick="resetZoom()">ğŸ”„é‡ç½®</button>
                    <button class="control-btn" onclick="cycleTheme()">ğŸ¨ä¸»é¢˜</button>
                    <button class="control-btn" onclick="jumpToCodeView()">ğŸš€è·³è½¬æŸ¥çœ‹</button>
                </div>
            </div>
            <textarea class="code-input" id="codeInput" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„HTMLã€CSS æˆ–JavaScript ä»£ç ...
ç¤ºä¾‹ï¼š <!DOCTYPE html>
<html>
<head>
<title>ç¤ºä¾‹é¡µé¢</title>
<style>
body { font-family: Arial; background: #f0f0f0; }
.container { max-width: 800px; margin: 0 auto; padding: 20px; }
</style>
</head>
<body>
<div class='container'>
<h1>æ¬¢è¿ä½¿ç”¨ä»£ç é«˜äº®æŸ¥çœ‹å™¨</h1>
<p>è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹é¡µé¢</p>
<button onclick='alert(\"æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼\")'>ç‚¹å‡»æˆ‘</button>
</div>
</body>
</html>"></textarea>
        </div>
        
        <!-- ä»£ç æŸ¥çœ‹åŒºåŸŸ-->
        <div class="code-view" id="codeView">
            <div class="code-header">
                <div class="code-title" id="codeTitle">ä»£ç é«˜äº®æ˜¾ç¤º</div>
                <div class="code-controls">
                    <button class="control-btn" onclick="adjustZoom(-2)">ğŸ”- ç¼©å°</button>
                    <button class="control-btn" onclick="adjustZoom(2)">ğŸ”+ æ”¾å¤§</button>
                    <button class="control-btn" onclick="resetZoom()">ğŸ”„é‡ç½®</button>
                    <button class="control-btn" onclick="cycleTheme()">ğŸ¨ä¸»é¢˜</button>
                    <button class="control-btn" onclick="copyCode()">ğŸ“‹å¤åˆ¶ä»£ç </button>
                    <button class="control-btn" onclick="backToInput()">â†è¿”å›è¾“å…¥</button>
                </div>
            </div>
            <div class="code-container" id="codeContainer">
                <div class="loading">æ­£åœ¨åŠ è½½ä»£ç ...</div>
            </div>
        </div>
    </div>
</div>

<!-- æµ®åŠ¨æ§åˆ¶æŒ‰é’®ï¼ˆå…¨å±æ¨¡å¼ï¼‰ -->
<div class="floating-controls" id="floatingControls" style="display: none;">
    <button class="control-btn" onclick="adjustZoom(-2)">ğŸ”-</button>
    <button class="control-btn" onclick="adjustZoom(2)">ğŸ”+</button>
    <button class="control-btn" onclick="resetZoom()">ğŸ”„</button>
    <button class="control-btn" onclick="cycleTheme()">ğŸ¨</button>
    <button class="control-btn" onclick="copyCode()">ğŸ“‹</button>
    <button class="control-btn" onclick="backToInput()">â†</button>
</div>

<!-- æ¨ªå±æç¤º-->
<div class="orientation-notice" id="orientationNotice">
    <h3>ğŸ“±æ¨ªå±ä½“éªŒæ›´ä½³</h3>
    <p>å»ºè®®å°†è®¾å¤‡æ¨ªå±ä»¥è·å¾—æ›´å¥½çš„ä»£ç æŸ¥çœ‹ä½“éªŒ</p>
    <button class="control-btn" onclick="hideOrientationNotice()">æˆ‘çŸ¥é“äº†</button>
</div>

<!-- Toast æç¤º-->
<div class="toast" id="toast"></div>

<!-- å¼•å…¥æ•°æ®åº“API -->
<script src="/db.js"></script>

<script>
// æŸ¥çœ‹æºç ï¼Œè®°å¾—äººå·¥æ™ºèƒ½åŠ æ³¨é‡Š
// æ•°æ®åº“å‰ç¼€é…ç½®
const DB_PREFIX = 'D_';
let currentFontSize = 14;
let currentCode = '';
let prismLoaded = false;
let orientationShown = false;
let currentThemeIndex = 0;

// é«˜äº®ä¸»é¢˜é…ç½®
const themes = [
    { name: 'Tomorrow Night', url: 'prism-tomorrow.min.css' },
    { name: 'Dark', url: 'prism-dark.min.css' },
    { name: 'Okaidia', url: 'prism-okaidia.min.css' },
    { name: 'VSC Dark Plus', url: 'prism-vsc-dark-plus.min.css' },
    { name: 'Atom Dark', url: 'prism-atom-dark.min.css' },
    { name: 'Synthwave 84', url: 'prism-synthwave84.min.css' },
    { name: 'Dracula', url: 'prism-dracula.min.css' },
    { name: 'Material Dark', url: 'prism-material-dark.min.css' }
];

// åˆå§‹åŒ–
window.onload = async function() {
    await initApp();
};

// åˆå§‹åŒ–åº”ç”¨
async function initApp() {
    try {
        // ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–
        await IDB.init();
        console.log('æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
        
        // ä»æ•°æ®åº“åŠ è½½ä¿å­˜çš„ä»£ç å’Œä¸»é¢˜
        const savedCode = await IDB.get(`${DB_PREFIX}userCode`, 'userdata');
        const savedTheme = await IDB.get(`${DB_PREFIX}currentTheme`, 'userdata');
        
        if (savedCode) {
            document.getElementById('codeInput').value = savedCode;
            currentCode = savedCode;
            showToast('å·²æ¢å¤ä¸Šæ¬¡è¾“å…¥çš„ä»£ç ');
        }
        
        if (savedTheme !== null) {
            currentThemeIndex = savedTheme;
            applyTheme(currentThemeIndex);
        }
        
        // è®¾ç½®è¾“å…¥æ¡†ç‚¹å‡»æ¸…é™¤placeholder
        setupInputClear();
        
        // ç›‘å¬è¾“å…¥å˜åŒ–
        document.getElementById('codeInput').addEventListener('input', function() {
            currentCode = this.value;
            autoSave();
        });
        
        // æ£€æŸ¥å±å¹•æ–¹å‘ï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼‰
        checkOrientation();
        
        // ç›‘å¬å±å¹•æ–¹å‘å˜åŒ–
        window.addEventListener('orientationchange', checkOrientation);
        window.addEventListener('resize', checkOrientation);
        
    } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        showToast('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    }
}

// è®¾ç½®è¾“å…¥æ¡†ç‚¹å‡»æ¸…é™¤placeholder
function setupInputClear() {
    const input = document.getElementById('codeInput');
    let originalPlaceholder = input.placeholder;
    let placeholderCleared = false;
    
    input.addEventListener('focus', function() {
        if (!placeholderCleared && this.value === '') {
            this.placeholder = '';
            placeholderCleared = true;
        }
    });
    
    input.addEventListener('blur', function() {
        if (placeholderCleared && this.value === '') {
            this.placeholder = originalPlaceholder;
            placeholderCleared = false;
        }
    });
    
    // ç‚¹å‡»æ—¶æ¸…é™¤placeholderå†…å®¹
    input.addEventListener('click', function() {
        if (!placeholderCleared && this.value === '') {
            this.placeholder = '';
            placeholderCleared = true;
        }
    });
}

// åˆ‡æ¢é«˜äº®ä¸»é¢˜
async function cycleTheme() {
    currentThemeIndex = (currentThemeIndex + 1) % themes.length;
    await applyTheme(currentThemeIndex);
    showToast(`å·²åˆ‡æ¢åˆ°: ${themes[currentThemeIndex].name}`);
    
    // é‡æ–°åº”ç”¨é«˜äº®
    if (window.Prism && currentCode) {
        displayCode();
    }
    
    // ä¿å­˜ä¸»é¢˜è®¾ç½®
    try {
        await IDB.put(`${DB_PREFIX}currentTheme`, currentThemeIndex, 'userdata');
    } catch (error) {
        console.error('ä¿å­˜ä¸»é¢˜å¤±è´¥:', error);
    }
}

// åº”ç”¨ä¸»é¢˜
async function applyTheme(index) {
    const theme = themes[index];
    const themeLink = document.getElementById('prism-theme');
    
    // æ›´æ–°CSSé“¾æ¥
    themeLink.href = `https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/${theme.url}`;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('active');
    });
}

// è‡ªåŠ¨ä¿å­˜
let autoSaveTimer;
function autoSave() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(async () => {
        try {
            await IDB.put(`${DB_PREFIX}userCode`, currentCode, 'userdata');
            console.log('ä»£ç å·²è‡ªåŠ¨ä¿å­˜');
        } catch (error) {
            console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
        }
    }, 1000);
}

// è·³è½¬åˆ°ä»£ç æŸ¥çœ‹é¡µé¢
async function jumpToCodeView() {
    if (!currentCode.trim()) {
        showToast('è¯·å…ˆè¾“å…¥ä»£ç ');
        return;
    }

    // ä¿å­˜ä»£ç åˆ°æ•°æ®åº“
    try {
        await IDB.put(`${DB_PREFIX}userCode`, currentCode, 'userdata');
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
    }

    // åˆ‡æ¢è§†å›¾
    document.getElementById('inputSection').style.display = 'none';
    document.getElementById('codeView').classList.add('active', 'fullscreen');
    
    // æ˜¾ç¤ºæµ®åŠ¨æ§åˆ¶æŒ‰é’®
    document.getElementById('floatingControls').style.display = 'flex';
    
    // åŠ è½½Prism.jsï¼ˆå¦‚æœè¿˜æœªåŠ è½½ï¼‰
    if (!prismLoaded) {
        await loadPrism();
        prismLoaded = true;
    }

    // æ˜¾ç¤ºä»£ç 
    displayCode();
    
    // æ·»åŠ æ³¨é‡Šæç¤º
    addCommentHint();
    
    // æ£€æŸ¥æ¨ªå±ï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼‰
    checkOrientation();
    
    showToast('å·²è·³è½¬åˆ°ä»£ç æŸ¥çœ‹é¡µé¢');
}

// è¿”å›è¾“å…¥é¡µé¢
function backToInput() {
    // ç§»é™¤å…¨å±ç±»
    document.getElementById('codeView').classList.remove('fullscreen');
    
    // éšè—æµ®åŠ¨æ§åˆ¶æŒ‰é’®
    document.getElementById('floatingControls').style.display = 'none';
    
    document.getElementById('codeView').classList.remove('active');
    document.getElementById('inputSection').style.display = 'block';
    showToast('å·²è¿”å›è¾“å…¥é¡µé¢');
}

// æ˜¾ç¤ºä»£ç é«˜äº®
function displayCode() {
    const container = document.getElementById('codeContainer');
    const language = detectLanguage(currentCode);
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ³¨é‡Š
    const hasComments = checkForComments(currentCode);
    let codeHtml = `<pre><code class="language-${language}">${escapeHtml(currentCode)}</code></pre>`;
    
    // å¦‚æœæ²¡æœ‰æ³¨é‡Šï¼Œæ·»åŠ æç¤º
    if (!hasComments) {
        codeHtml = `
            <div class="comment-hint">
                ğŸ’¡ <strong>ç¼–ç¨‹å»ºè®®ï¼š</strong>åœ¨äººå·¥æ™ºèƒ½æ—¶ä»£ï¼Œè‰¯å¥½çš„æ³¨é‡Šä¹ æƒ¯å˜å¾—æ›´åŠ é‡è¦ã€‚
                å»ºè®®åœ¨ç¼–å†™ä»£ç æ—¶å…ˆæ·»åŠ æ¸…æ™°çš„æ³¨é‡Šï¼Œè¿™æœ‰åŠ©äºAIæ›´å¥½åœ°ç†è§£æ‚¨çš„ä»£ç æ„å›¾ï¼Œ
                ä¹Ÿä¾¿äºå›¢é˜Ÿåä½œå’Œåç»­ç»´æŠ¤ã€‚æ³¨é‡Šåº”è¯¥ç®€æ´æ˜äº†ï¼Œè¯´æ˜ä»£ç çš„ç›®çš„å’Œé€»è¾‘ã€‚
            </div>
            ${codeHtml}
        `;
    }
    
    container.innerHTML = codeHtml;
    
    // åº”ç”¨é«˜äº®
    if (window.Prism) {
        Prism.highlightAll();
    }
    
    // åº”ç”¨å½“å‰å­—ä½“å¤§å°
    applyFontSize();
}

// æ£€æŸ¥ä»£ç æ˜¯å¦åŒ…å«æ³¨é‡Š
function checkForComments(code) {
    // æ£€æŸ¥HTMLæ³¨é‡Š
    if (code.includes('<!--')) return true;
    // æ£€æŸ¥CSSæ³¨é‡Š
    if (code.includes('/*')) return true;
    // æ£€æŸ¥JavaScriptæ³¨é‡Š
    if (code.includes('//') || code.includes('/*')) return true;
    // æ£€æŸ¥Pythonæ³¨é‡Š
    if (code.includes('#')) return true;
    return false;
}

// æ·»åŠ æ³¨é‡Šæç¤º
function addCommentHint() {
    // è¿™ä¸ªå‡½æ•°åœ¨displayCodeä¸­å·²ç»é›†æˆ
}

// æ£€æµ‹ä»£ç è¯­è¨€
function detectLanguage(code) {
    if (code.includes('<!DOCTYPE') || code.includes('<html')) return 'html';
    if (code.includes('function') || code.includes('const ') || code.includes('let ')) return 'javascript';
    if (code.includes('{') && code.includes(':') && code.includes(';')) return 'css';
    if (code.includes('def ') || code.includes('import ')) return 'python';
    if (code.includes('public class') || code.includes('import java')) return 'java';
    return 'javascript';
}

// åŠ è½½Prism.js
async function loadPrism() {
    // åŠ è½½æ ¸å¿ƒåº“
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js');
    // åŠ è½½è‡ªåŠ¨åŠ è½½å™¨
    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js');
}

// åŠ è½½è„šæœ¬
function loadScript(url) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

// è°ƒæ•´å­—ä½“å¤§å°
function adjustZoom(delta) {
    currentFontSize = Math.max(10, Math.min(24, currentFontSize + delta));
    applyFontSize();
    showToast(`å­—ä½“å¤§å°: ${currentFontSize}px`);
}

// åº”ç”¨å­—ä½“å¤§å°
function applyFontSize() {
    document.documentElement.style.setProperty('--base-font-size', currentFontSize + 'px');
    
    // ç›´æ¥è®¾ç½®ä»£ç åŒºåŸŸçš„å­—ä½“å¤§å°
    const codeElements = document.querySelectorAll('pre[class*="language-"], .code-input');
    codeElements.forEach(element => {
        element.style.fontSize = currentFontSize + 'px';
    });
}

// é‡ç½®å­—ä½“å¤§å°
function resetZoom() {
    currentFontSize = 14;
    applyFontSize();
    showToast('å­—ä½“å¤§å°å·²é‡ç½®');
}

// å¤åˆ¶ä»£ç 
function copyCode() {
    if (currentCode) {
        navigator.clipboard.writeText(currentCode).then(() => {
            showToast('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(() => {
            showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
        });
    }
}

// HTML è½¬ä¹‰
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// æ£€æŸ¥å±å¹•æ–¹å‘
function checkOrientation() {
    // å¦‚æœå·²ç»æ˜¾ç¤ºè¿‡ï¼Œå°±ä¸å†æ˜¾ç¤º
    if (orientationShown) return;
    
    const isPortrait = window.innerHeight > window.innerWidth;
    if (isPortrait && window.innerWidth <= 768) {
        const notice = document.getElementById('orientationNotice');
        notice.classList.add('show');
        orientationShown = true;
        
        // 5 ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            hideOrientationNotice();
        }, 5000);
    }
}

// éšè—æ¨ªå±æç¤º
function hideOrientationNotice() {
    const notice = document.getElementById('orientationNotice');
    notice.classList.remove('show');
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// é¡µé¢å…³é—­å‰ä¿å­˜
window.addEventListener('beforeunload', async () => {
    if (currentCode) {
        try {
            await IDB.put(`${DB_PREFIX}userCode`, currentCode, 'userdata');
            await IDB.put(`${DB_PREFIX}currentTheme`, currentThemeIndex, 'userdata');
        } catch (error) {
            console.error('å…³é—­å‰ä¿å­˜å¤±è´¥:', error);
        }
    }
});

// å¿«æ·é”®æ”¯æŒ
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter è·³è½¬æŸ¥çœ‹
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        if (document.getElementById('inputSection').style.display !== 'none') {
            jumpToCodeView();
        }
    }
    
    // Ctrl+S ä¿å­˜
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        autoSave();
        showToast('ä»£ç å·²ä¿å­˜');
    }
    
    // ESC è¿”å›
    if (e.key === 'Escape' && document.getElementById('codeView').classList.contains('active')) {
        backToInput();
    }
    
    // Ctrl+Plus/Minus è°ƒæ•´å­—ä½“å¤§å°
    if (e.ctrlKey || e.metaKey) {
        if (e.key === '+' || e.key === '=') {
            e.preventDefault();
            adjustZoom(2);
        } else if (e.key === '-' || e.key === '_') {
            e.preventDefault();
            adjustZoom(-2);
        } else if (e.key === '0') {
            e.preventDefault();
            resetZoom();
        } else if (e.key === 't' || e.key === 'T') {
            e.preventDefault();
            cycleTheme();
        }
    }
});
</script>
</body>
</html>
