<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£ç æ–‡ä»¶é˜…è¯»å™¨</title>
    
    <!-- Prism.js ä»£ç é«˜äº® -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" id="prism-theme">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>  
    
    <!-- å¼•å…¥æ•°æ®åº“ç®¡ç†å™¨ -->
    <script src="/db.js"></script>
    <!-- å¼•å…¥ç¼©æ”¾æ’ä»¶ -->
    <script src="/A2_å…¨å±€ä¸­å¿ƒ/B_æ’ä»¶å·¥å…·/3.æ’ä»¶_å­—ä½“ç¼©æ”¾.js"></script>
    
    
    <!-- å¼•å…¥æ ·å¼é…ç½®æ–‡ä»¶ -->
    <script src="5_style_config.js"></script>   
    <!-- å¼•å…¥é…ç½®æ–‡ä»¶ -->
    <script src="5_æ¸—é€æµ‹è¯•.js"></script>

    <script>
        let currentFileIndex = 0;
        let allFiles = [];
        let configData = null;

        // é…ç½®æ–‡ä»¶é”®å
        const CONFIG_KEY = 'E_æ¸—é€æµ‹è¯•èµ„æ–™';
        const STYLE_KEY = 'E_æ ·å¼é…ç½®';

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('ğŸš€ é¡µé¢å¼€å§‹åˆå§‹åŒ–...');
                
                // ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–
                await IDB.init();
                console.log('âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');

                // åŠ è½½æ ·å¼é…ç½®
                await loadStyleConfig();

                // åŠ è½½é…ç½®ï¼ˆä¼˜å…ˆä»æ•°æ®åº“ï¼Œæ²¡æœ‰åˆ™ä»JSæ–‡ä»¶ï¼‰
                await loadConfig();

                // ç»‘å®šæœç´¢åŠŸèƒ½
                document.getElementById('searchInput').addEventListener('input', handleSearch);

                // ç»‘å®šESCé”®å…³é—­å¼¹çª—
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                    }
                });

            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        });

        // åŠ è½½æ ·å¼é…ç½®ï¼ˆä¼˜å…ˆæ•°æ®åº“ï¼Œæ²¡æœ‰åˆ™ä»JSæ–‡ä»¶ï¼‰
        async function loadStyleConfig() {
            try {
                console.log('ğŸ”„ å¼€å§‹åŠ è½½æ ·å¼é…ç½®...');
                
                // 1. å…ˆæ£€æŸ¥æ•°æ®åº“
                const styleText = await IDB.get(STYLE_KEY, 'userdata');
                
                if (styleText) {
                    console.log('âœ… æ ·å¼é…ç½®æ•°æ®åº“å‘½ä¸­');
                    applyStyleConfig(styleText);
                } else {
                    console.log('âš ï¸ æ ·å¼é…ç½®æ•°æ®åº“æœªå‘½ä¸­ï¼Œä½¿ç”¨JSæ–‡ä»¶');
                    
                    // 2. æ•°æ®åº“æ²¡æœ‰ï¼Œä»JSæ–‡ä»¶è·å–
                    if (typeof styleConfig !== 'undefined') {
                        const styleString = JSON.stringify(styleConfig);
                        
                        // å­˜å‚¨åˆ°æ•°æ®åº“
                        await IDB.put(STYLE_KEY, styleString, 'userdata');
                        console.log('âœ… æ ·å¼é…ç½®å·²ç¼“å­˜åˆ°æ•°æ®åº“');
                        
                        applyStyleConfig(styleString);
                    } else {
                        throw new Error('æ ·å¼é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°');
                    }
                }
            } catch (error) {
                console.error('âŒ åŠ è½½æ ·å¼é…ç½®å¤±è´¥:', error);
                throw error;
            }
        }

        // åº”ç”¨æ ·å¼é…ç½®
        function applyStyleConfig(styleText) {
            try {
                const styleConfig = JSON.parse(styleText);
                
                // åˆ›å»ºstyleæ ‡ç­¾å¹¶æ’å…¥CSS
                const styleElement = document.createElement('style');
                styleElement.textContent = styleConfig.css;
                document.head.appendChild(styleElement);
                
                // ä¿å­˜åè½¬ä¹‰å‡½æ•°åˆ°å…¨å±€
                window.unescapeContent = styleConfig.unescapeContent;
                
                console.log('âœ… æ ·å¼é…ç½®åº”ç”¨æˆåŠŸ');
            } catch (error) {
                console.error('âŒ åº”ç”¨æ ·å¼é…ç½®å¤±è´¥:', error);
                throw error;
            }
        }

        // åŠ è½½é…ç½®ï¼ˆä¼˜å…ˆæ•°æ®åº“ï¼Œæ²¡æœ‰åˆ™ä»JSæ–‡ä»¶ï¼‰
        async function loadConfig() {
            try {
                console.log('ğŸ”„ å¼€å§‹åŠ è½½é…ç½®...');
                
                // 1. å…ˆæ£€æŸ¥æ•°æ®åº“
                const configText = await IDB.get(CONFIG_KEY, 'userdata');
                
                if (configText) {
                    console.log('âœ… æ•°æ®åº“å‘½ä¸­ï¼Œä½¿ç”¨ç¼“å­˜é…ç½®');
                    
                    // æ‰§è¡Œé…ç½®ä»£ç 
                    executeConfig(configText);
                    
                    // åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨
                    initializeFileList();
                    
                    // åŠ è½½é˜…è¯»è¿›åº¦
                    const savedProgress = await IDB.get('E_readingProgress', 'userdata');
                    if (savedProgress) {
                        currentFileIndex = savedProgress.index || 0;
                    }
                } else {
                    console.log('âš ï¸ æ•°æ®åº“æœªå‘½ä¸­ï¼Œå°è¯•ä»JSæ–‡ä»¶åŠ è½½');
                    
                    // 2. æ•°æ®åº“æ²¡æœ‰ï¼Œä»JSæ–‡ä»¶è·å–
                    if (typeof codeFiles !== 'undefined') {
                        console.log('âœ… ä»JSæ–‡ä»¶åŠ è½½é…ç½®æˆåŠŸ');
                        
                        // å°†é…ç½®åºåˆ—åŒ–å­˜å‚¨åˆ°æ•°æ®åº“
                        const configString = JSON.stringify({
                            codeFiles: codeFiles,
                            codeFilesMeta: typeof codeFilesMeta !== 'undefined' ? codeFilesMeta : {}
                        });
                        
                        await IDB.put(CONFIG_KEY, configString, 'userdata');
                        console.log('âœ… é…ç½®å·²ç¼“å­˜åˆ°æ•°æ®åº“');
                        
                        // åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨
                        initializeFileList();
                    } else {
                        console.error('âŒ JSæ–‡ä»¶ä¸­æœªæ‰¾åˆ°codeFiles');
                        showError('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæœªæ‰¾åˆ°codeFiles');
                    }
                }
            } catch (error) {
                console.error('âŒ åŠ è½½é…ç½®å¤±è´¥:', error);
                showError('åŠ è½½é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        // æ‰§è¡Œé…ç½®ä»£ç 
        function executeConfig(configText) {
            try {
                if (typeof configText === 'string') {
                    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œè§£æä¸ºJSON
                    const config = JSON.parse(configText);
                    if (config.codeFiles) {
                        window.codeFiles = config.codeFiles;
                    }
                    if (config.codeFilesMeta) {
                        window.codeFilesMeta = config.codeFilesMeta;
                    }
                }
                console.log('âœ… é…ç½®ä»£ç æ‰§è¡ŒæˆåŠŸ');
            } catch (error) {
                console.error('âŒ é…ç½®ä»£ç æ‰§è¡Œå¤±è´¥:', error);
                throw error;
            }
        }

        // åˆå§‹åŒ–æ–‡ä»¶åˆ—è¡¨
        function initializeFileList() {
            if (typeof codeFiles !== 'undefined') {
                allFiles = Object.keys(codeFiles).map(varName => ({
                    variableName: varName,
                    filename: codeFiles[varName].filename,
                    content: codeFiles[varName].content,
                    size: codeFiles[varName].size,
                    modTime: codeFiles[varName].modTime,
                    index: codeFiles[varName].index
                }));

                // æŒ‰ç´¢å¼•æ’åº
                allFiles.sort((a, b) => a.index - b.index);

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('totalFiles').textContent = allFiles.length;
                document.getElementById('fileCount').textContent = `å…± ${allFiles.length} ä¸ªæ–‡ä»¶`;

                // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
                renderFileList();
                
                console.log(`âœ… å·²åŠ è½½ ${allFiles.length} ä¸ªæ–‡ä»¶`);
            } else {
                showError('é…ç½®æ•°æ®æ ¼å¼é”™è¯¯');
            }
        }

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFileList(searchResults = null) {
            const fileList = document.getElementById('fileList');
            const filesToShow = searchResults || allFiles;
            
            fileList.innerHTML = '';
            filesToShow.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                const actualIndex = allFiles.findIndex(f => f.variableName === file.variableName);
                if (actualIndex === currentFileIndex && !searchResults) {
                    fileItem.classList.add('active');
                }
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.index}. ${file.filename}</div>
                        <div class="file-meta">${file.modTime}</div>
                    </div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                `;
                
                fileItem.onclick = () => {
                    openFileInModal(actualIndex);
                };
                
                fileList.appendChild(fileItem);
            });
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // åœ¨å¼¹çª—ä¸­æ‰“å¼€æ–‡ä»¶
        function openFileInModal(index) {
            if (index < 0 || index >= allFiles.length) return;

            currentFileIndex = index;
            const file = allFiles[index];

            // æ›´æ–°å¼¹çª—æ ‡é¢˜
            document.getElementById('modalTitle').textContent = `${file.index}. ${file.filename}`;

            // æ›´æ–°å†…å®¹åŒºåŸŸ - ä¿®å¤æ¢è¡Œé—®é¢˜
            const contentArea = document.getElementById('modalContent');
            let content = file.content;

            // ä½¿ç”¨åè½¬ä¹‰å‡½æ•°ä¿®å¤\né—®é¢˜
            if (window.unescapeContent) {
                content = window.unescapeContent(content);
            }

            // æ£€æµ‹æ–‡ä»¶ç±»å‹å¹¶åº”ç”¨è¯­æ³•é«˜äº®
            const extension = file.filename.split('.').pop().toLowerCase();
            let languageClass = '';
            
            switch(extension) {
                case 'js': languageClass = 'language-javascript'; break;
                case 'py': languageClass = 'language-python'; break;
                case 'java': languageClass = 'language-java'; break;
                case 'c': case 'cpp': case 'h': case 'hpp': languageClass = 'language-cpp'; break;
                case 'css': languageClass = 'language-css'; break;
                case 'html': case 'htm': languageClass = 'language-html'; break;
                case 'json': languageClass = 'language-json'; break;
                case 'sql': languageClass = 'language-sql'; break;
                case 'sh': case 'bash': languageClass = 'language-bash'; break;
                case 'xml': languageClass = 'language-xml'; break;
                case 'yaml': case 'yml': languageClass = 'language-yaml'; break;
                case 'md': languageClass = 'language-markdown'; break;
                default: languageClass = 'language-text';
            }

            contentArea.innerHTML = `<pre><code class="${languageClass}">${content.replace(/\\n/g, '\n')}</code></pre>`;

            // åº”ç”¨è¯­æ³•é«˜äº®
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }

            // æ›´æ–°å¯¼èˆª
            updateModalNavigation();

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();

            // ä¿å­˜é˜…è¯»è¿›åº¦åˆ°æ•°æ®åº“
            IDB.put('E_readingProgress', { index: currentFileIndex }, 'userdata');

            // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ¿€æ´»çŠ¶æ€
            renderFileList();

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('fileModal').classList.add('active');
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('fileModal').classList.remove('active');
        }

        // æ›´æ–°å¼¹çª—å¯¼èˆª
        function updateModalNavigation() {
            const prevBtn = document.getElementById('modalPrevBtn');
            const nextBtn = document.getElementById('modalNextBtn');
            const pageInfo = document.getElementById('modalPageInfo');

            prevBtn.disabled = currentFileIndex <= 0;
            nextBtn.disabled = currentFileIndex >= allFiles.length - 1;

            if (allFiles.length > 0) {
                pageInfo.textContent = `${currentFileIndex + 1} / ${allFiles.length}`;
            } else {
                pageInfo.textContent = 'æ— æ–‡ä»¶';
            }
        }

        // å¼¹çª—ä¸­çš„å¯¼èˆªåŠŸèƒ½
        function previousFileInModal() {
            if (currentFileIndex > 0) {
                openFileInModal(currentFileIndex - 1);
            }
        }

        function nextFileInModal() {
            if (currentFileIndex < allFiles.length - 1) {
                openFileInModal(currentFileIndex + 1);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('currentFile').textContent = currentFileIndex + 1;
            const progress = Math.round(((currentFileIndex + 1) / allFiles.length) * 100);
            document.getElementById('readProgress').textContent = progress + '%';
            document.getElementById('progressBar').style.width = progress + '%';
        }

        // æœç´¢åŠŸèƒ½
        function handleSearch(event) {
            const keyword = event.target.value.toLowerCase();
            
            if (!keyword) {
                renderFileList();
                return;
            }

            const results = allFiles.filter(file => 
                file.filename.toLowerCase().includes(keyword) ||
                file.content.toLowerCase().includes(keyword)
            );

            renderFileList(results);
        }

        // ä¸»é¢˜åˆ‡æ¢
        function switchTheme() {
            const body = document.body;
            const themeBtn = document.querySelector('.theme-btn');
            
            if (body.getAttribute('data-theme') === 'light') {
                body.removeAttribute('data-theme');
                themeBtn.textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'dark');
            } else {
                body.setAttribute('data-theme', 'light');
                themeBtn.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'light');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeBtn = document.querySelector('.theme-btn');
            
            if (savedTheme === 'light') {
                document.body.setAttribute('data-theme', 'light');
                themeBtn.textContent = 'â˜€ï¸';
            }
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // é”™è¯¯æ˜¾ç¤º
        function showError(message) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = `
                <div style="text-align: center; color: #ff4444; padding: 50px;">
                    <h3>âŒ é”™è¯¯</h3>
                    <p>${message}</p>
                </div>
            `;
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š ä»£ç æ–‡ä»¶é˜…è¯»å™¨</h1>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="controls">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ–‡ä»¶å...">
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <span>æ–‡ä»¶:</span>
                        <span class="stat-value" id="totalFiles">0</span>
                    </div>
                    <div class="stat-item">
                        <span>å½“å‰:</span>
                        <span class="stat-value" id="currentFile">0</span>
                    </div>
                    <div class="stat-item">
                        <span>è¿›åº¦:</span>
                        <span class="stat-value" id="readProgress">0%</span>
                    </div>
                </div>
            </div>

            <div class="file-list-container">
                <div class="file-list-header">
                    <span>ğŸ“ æ–‡ä»¶åˆ—è¡¨</span>
                    <span id="fileCount">å…± 0 ä¸ªæ–‡ä»¶</span>
                </div>
                <div class="file-list" id="fileList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»é¢˜åˆ‡æ¢å™¨ -->
    <div class="theme-switcher">
        <button class="theme-btn" onclick="switchTheme()">ğŸŒ™</button>
    </div>

    <!-- æ–‡ä»¶é˜…è¯»å¼¹çª— -->
    <div class="modal" id="fileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">æ–‡ä»¶å</div>
                <button class="modal-close" onclick="closeModal()">âœ• å…³é—­</button>
            </div>
            <div class="modal-body">
                <div class="content-area" id="modalContent">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        æ­£åœ¨åŠ è½½å†…å®¹...
                    </div>
                </div>
            </div>
            <div class="modal-navigation">
                <button class="nav-button" id="modalPrevBtn" onclick="previousFileInModal()">â¬…ï¸ ä¸Šä¸€ä¸ª</button>
                <div class="stat-value" id="modalPageInfo">1 / 1</div>
                <button class="nav-button" id="modalNextBtn" onclick="nextFileInModal()">ä¸‹ä¸€ä¸ª â¡ï¸</button>
            </div>
        </div>
    </div>
</body>
</html>
